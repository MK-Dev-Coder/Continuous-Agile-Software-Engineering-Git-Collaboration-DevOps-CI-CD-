<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech Test - Smart Home AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-area {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .text-display {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Š Speech Enhancement Test</h1>
    
    <div class="test-area">
        <h2>Test 1: Markdown and Emoji Filtering</h2>
        <p>This test will speak text with <strong>asterisks</strong> and emojis to verify they're filtered out.</p>
        <button class="test-button" onclick="testMarkdownFiltering()">ğŸ¤ Test Markdown Filtering</button>
        <div id="markdown-text" class="text-display"></div>
    </div>
    
    <div class="test-area">
        <h2>Test 2: Long Text Chunking</h2>
        <p>This test will speak a very long response to verify it doesn't cut off.</p>
        <button class="test-button" onclick="testLongTextChunking()">ğŸ—£ï¸ Test Long Text</button>
        <div id="long-text" class="text-display"></div>
    </div>
    
    <div class="test-area">
        <h2>Test 3: AI-style Response</h2>
        <p>This simulates a typical AI response with markdown and emojis.</p>
        <button class="test-button" onclick="testAIResponse()">ğŸ¤– Test AI Response</button>
        <div id="ai-text" class="text-display"></div>
    </div>

    <script>
        // Load the same speech functions from the main app
        const voices = [];
        let speechSynthesis = window.speechSynthesis;
        
        // Load voices
        function loadVoices() {
            const availableVoices = speechSynthesis.getVoices();
            voices.splice(0, voices.length, ...availableVoices);
        }
        
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();
        
        // Copy the enhanced functions from main script
        function removeEmojis(text) {
            return text
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // Emoticons
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // Misc Symbols and Pictographs
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // Transport and Map
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // Regional indicator symbols
                .replace(/[\u{2600}-\u{26FF}]/gu, '')   // Misc symbols
                .replace(/[\u{2700}-\u{27BF}]/gu, '')   // Dingbats
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '') // Supplemental Symbols and Pictographs
                .replace(/[\u{1FA70}-\u{1FAFF}]/gu, '') // Symbols and Pictographs Extended-A
                .replace(/[\u{FE00}-\u{FE0F}]/gu, '')   // Variation Selectors
                .replace(/[\u{200D}]/gu, '')            // Zero Width Joiner
                // Remove markdown formatting that sounds weird when spoken
                .replace(/\*\*([^*]+)\*\*/g, '$1')      // **bold** -> text
                .replace(/\*([^*]+)\*/g, '$1')          // *italic* -> text
                .replace(/`([^`]+)`/g, '$1')            // `code` -> text
                .replace(/#{1,6}\s*/g, '')              // Remove markdown headers
                .replace(/>\s*/g, '')                   // Remove blockquotes
                .replace(/[-*+]\s*/g, '')               // Remove list markers
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // [link text](url) -> link text
                .replace(/\s+/g, ' ')                   // Clean up extra whitespace
                .trim();
        }
        
        function splitTextForSpeech(text, maxLength = 200) {
            if (text.length <= maxLength) {
                return [text];
            }
            
            const chunks = [];
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            let currentChunk = '';
            
            for (const sentence of sentences) {
                const trimmedSentence = sentence.trim();
                if (currentChunk.length + trimmedSentence.length + 1 <= maxLength) {
                    currentChunk += (currentChunk ? '. ' : '') + trimmedSentence;
                } else {
                    if (currentChunk) {
                        chunks.push(currentChunk + '.');
                        currentChunk = trimmedSentence;
                    } else {
                        if (trimmedSentence.length > maxLength) {
                            const words = trimmedSentence.split(' ');
                            let wordChunk = '';
                            for (const word of words) {
                                if (wordChunk.length + word.length + 1 <= maxLength) {
                                    wordChunk += (wordChunk ? ' ' : '') + word;
                                } else {
                                    if (wordChunk) chunks.push(wordChunk);
                                    wordChunk = word;
                                }
                            }
                            if (wordChunk) currentChunk = wordChunk;
                        } else {
                            currentChunk = trimmedSentence;
                        }
                    }
                }
            }
            
            if (currentChunk) {
                chunks.push(currentChunk + (currentChunk.endsWith('.') ? '' : '.'));
            }
            
            return chunks.filter(chunk => chunk.trim().length > 0);
        }
        
        function speak(text) {
            console.log('ğŸ”Š Speaking:', text);
            
            if (!text || text.trim() === '') {
                console.log('âš ï¸ No text to speak');
                return;
            }
            
            const cleanTextForSpeech = removeEmojis(text);
            console.log('ğŸ—£ï¸ Clean text for speech:', cleanTextForSpeech);
            
            speechSynthesis.cancel();
            
            const textChunks = splitTextForSpeech(cleanTextForSpeech, 200);
            console.log('ğŸ“ Text split into', textChunks.length, 'chunks');
            
            function speakChunk(chunkIndex = 0) {
                if (chunkIndex >= textChunks.length) {
                    console.log('âœ… All speech chunks completed');
                    return;
                }
                
                const chunk = textChunks[chunkIndex];
                console.log(`ğŸ—£ï¸ Speaking chunk ${chunkIndex + 1}/${textChunks.length}:`, chunk);
                
                try {
                    const utterance = new SpeechSynthesisUtterance(chunk);
                    
                    if (voices && voices[0]) {
                        utterance.voice = voices[0];
                    }
                    
                    utterance.rate = 1.0;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    
                    utterance.onend = function() {
                        console.log(`âœ… Chunk ${chunkIndex + 1} completed`);
                        setTimeout(() => {
                            speakChunk(chunkIndex + 1);
                        }, 100);
                    };
                    
                    utterance.onerror = function(event) {
                        console.error(`âŒ Speech error in chunk ${chunkIndex + 1}:`, event.error);
                        setTimeout(() => {
                            speakChunk(chunkIndex + 1);
                        }, 100);
                    };
                    
                    speechSynthesis.speak(utterance);
                    
                } catch (error) {
                    console.error(`âŒ Error in speak function chunk ${chunkIndex + 1}:`, error);
                    setTimeout(() => {
                        speakChunk(chunkIndex + 1);
                    }, 100);
                }
            }
            
            speakChunk(0);
        }
        
        // Test functions
        function testMarkdownFiltering() {
            const text = "ğŸ¤– **Hello!** I can speak *text* with `code blocks` and emojis ğŸ˜Š but they should **not** sound weird when spoken! ğŸµ";
            document.getElementById('markdown-text').textContent = 'Original: ' + text + '\n\nCleaned: ' + removeEmojis(text);
            speak(text);
        }
        
        function testLongTextChunking() {
            const text = `ğŸ  **Smart Home Status Report:** ğŸŒ¡ï¸ Your home temperature is currently 22.5 degrees Celsius, which is perfect for optimal comfort and energy efficiency. ğŸ’§ The humidity level is at 45%, indicating excellent air quality that prevents both dryness and excess moisture. ğŸ’¡ Lighting levels are measured at 450 lux, providing adequate illumination for daily activities without being too bright or harsh. ğŸš¶ Motion sensors indicate recent activity in the living room, suggesting someone is home and moving around normally. ğŸŒ± Plant monitoring shows your indoor plants are well-hydrated with soil moisture at optimal levels. ğŸ”’ Security systems are functioning normally with no alerts or concerns detected. âš¡ Energy usage is within normal parameters, and I've detected opportunities for optimization during peak hours. ğŸ¯ Overall, your smart home ecosystem is operating efficiently and maintaining excellent environmental conditions for comfort, health, and sustainability. Would you like specific recommendations for further optimization or have any questions about these readings?`;
            document.getElementById('long-text').textContent = 'Original: ' + text + '\n\nCleaned: ' + removeEmojis(text);
            speak(text);
        }
        
        function testAIResponse() {
            const text = `ğŸ¤– I'm **ARIA**, your Advanced Residential Intelligence Assistant! Here's what I can help you with: ğŸ  *Monitor all home sensors* including temperature, humidity, and lighting. ğŸ’¡ Provide **energy optimization** suggestions to save money and reduce environmental impact. ğŸŒ± Track your *plant health* and send watering reminders. ğŸ”’ Keep an eye on **security** and alert you to any unusual activity. ğŸ’¬ Engage in *natural conversations* and answer questions on virtually any topic! I use advanced AI to understand context, learn your preferences, and provide personalized assistance that goes far beyond basic smart home controls.`;
            document.getElementById('ai-text').textContent = 'Original: ' + text + '\n\nCleaned: ' + removeEmojis(text);
            speak(text);
        }
    </script>
</body>
</html>
